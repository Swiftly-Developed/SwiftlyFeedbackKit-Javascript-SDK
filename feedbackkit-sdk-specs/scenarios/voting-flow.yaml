name: Voting Flow
description: Test voting and unvoting on feedback items

variables:
  API_KEY: "${API_KEY}"
  BASE_URL: "${BASE_URL}"
  USER_ID: "test_voter_12345"
  FEEDBACK_ID: "${FEEDBACK_ID}"

tests:
  # === VOTE ===
  - name: Vote for feedback successfully
    request:
      method: POST
      path: /feedbacks/${FEEDBACK_ID}/votes
      headers:
        X-API-Key: "${API_KEY}"
        Content-Type: application/json
      body:
        userId: "${USER_ID}"
    response:
      status: 200
      body:
        feedbackId: "${FEEDBACK_ID}"
        hasVoted: true
        voteCount: { type: integer, minimum: 1 }

  - name: Vote with email for notifications
    request:
      method: POST
      path: /feedbacks/${FEEDBACK_ID}/votes
      headers:
        X-API-Key: "${API_KEY}"
        Content-Type: application/json
      body:
        userId: "voter_with_email"
        email: "voter@example.com"
        notifyStatusChange: true
    response:
      status: 200
      body:
        hasVoted: true

  - name: Vote - duplicate vote (conflict)
    description: Voting twice for the same feedback should fail
    request:
      method: POST
      path: /feedbacks/${FEEDBACK_ID}/votes
      headers:
        X-API-Key: "${API_KEY}"
        Content-Type: application/json
      body:
        userId: "${USER_ID}"
    response:
      status: 409
      body:
        error: true

  - name: Vote - missing userId
    request:
      method: POST
      path: /feedbacks/${FEEDBACK_ID}/votes
      headers:
        X-API-Key: "${API_KEY}"
        Content-Type: application/json
      body: {}
    response:
      status: 400

  - name: Vote - feedback not found
    request:
      method: POST
      path: /feedbacks/00000000-0000-0000-0000-000000000000/votes
      headers:
        X-API-Key: "${API_KEY}"
        Content-Type: application/json
      body:
        userId: "${USER_ID}"
    response:
      status: 404

  - name: Vote - cannot vote on completed feedback
    description: Voting is blocked on completed or rejected feedback
    request:
      method: POST
      path: /feedbacks/${COMPLETED_FEEDBACK_ID}/votes
      headers:
        X-API-Key: "${API_KEY}"
        Content-Type: application/json
      body:
        userId: "${USER_ID}"
    response:
      status: 403
      body:
        error: true

  - name: Vote - cannot vote on rejected feedback
    request:
      method: POST
      path: /feedbacks/${REJECTED_FEEDBACK_ID}/votes
      headers:
        X-API-Key: "${API_KEY}"
        Content-Type: application/json
      body:
        userId: "${USER_ID}"
    response:
      status: 403

  # === UNVOTE ===
  - name: Remove vote successfully
    request:
      method: DELETE
      path: /feedbacks/${FEEDBACK_ID}/votes
      headers:
        X-API-Key: "${API_KEY}"
        Content-Type: application/json
      body:
        userId: "${USER_ID}"
    response:
      status: 200
      body:
        feedbackId: "${FEEDBACK_ID}"
        hasVoted: false

  - name: Remove vote - not voted yet
    description: Removing a vote when user hasn't voted should still succeed
    request:
      method: DELETE
      path: /feedbacks/${FEEDBACK_ID}/votes
      headers:
        X-API-Key: "${API_KEY}"
        Content-Type: application/json
      body:
        userId: "user_never_voted"
    response:
      status: 200
      body:
        hasVoted: false

  - name: Remove vote - feedback not found
    request:
      method: DELETE
      path: /feedbacks/00000000-0000-0000-0000-000000000000/votes
      headers:
        X-API-Key: "${API_KEY}"
        Content-Type: application/json
      body:
        userId: "${USER_ID}"
    response:
      status: 404
